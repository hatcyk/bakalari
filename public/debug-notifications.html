<!DOCTYPE html>
<html>
<head>
    <title>Debug Notifikac√≠</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1a1a1a;
            color: #00ff00;
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #00ff00;
            border-radius: 5px;
        }
        .error { color: #ff4444; }
        .success { color: #00ff00; }
        .warning { color: #ffaa00; }
        button {
            padding: 10px 20px;
            background: #00ff00;
            color: #000;
            border: none;
            cursor: pointer;
            margin: 5px;
        }
    </style>
</head>
<body>
    <h1>üîç Debug Notifikac√≠</h1>

    <div class="section">
        <h2>‚ö†Ô∏è Kontrola Service Workers</h2>
        <div id="sw-warning" style="display: none; padding: 15px; background: #ff4444; color: #fff; margin-bottom: 15px; border-radius: 5px; font-weight: bold;">
            üö® PROBL√âM DETEKOV√ÅN: M√°≈° v√≠ce ne≈æ 1 Service Worker!<br>
            To zp≈Øsobuje duplicitn√≠ notifikace. Klikni na "FIX NOW!" n√≠≈æe.
        </div>
        <div id="sw-status"></div>
        <button onclick="checkServiceWorkers()">Zkontrolovat SW</button>
        <button onclick="cleanupServiceWorkers()" style="background: #ff4444; color: #fff; font-weight: bold;">üîß FIX NOW!</button>
    </div>

    <div class="section">
        <h2>Kontrola FCM Token≈Ø</h2>
        <div id="token-status"></div>
        <button onclick="checkTokens()">Zkontrolovat tokeny</button>
    </div>

    <div class="section">
        <h2>Test notifikace</h2>
        <div id="test-status"></div>
        <button onclick="sendTestNotification()">Poslat test</button>
    </div>

    <script>
        async function checkServiceWorkers() {
            const status = document.getElementById('sw-status');
            status.innerHTML = '<p>Kontroluji...</p>';

            try {
                const regs = await navigator.serviceWorker.getRegistrations();
                let html = `<p class="success">Nalezeno ${regs.length} Service Workers:</p>`;

                regs.forEach((reg, i) => {
                    const url = reg.active?.scriptURL || 'N/A';
                    const state = reg.active?.state || 'N/A';
                    const isBad = url.includes('/sw.js');

                    html += `<p class="${isBad ? 'error' : 'success'}">
                        ${i+1}. ${url}<br>
                        &nbsp;&nbsp;&nbsp;State: ${state}
                        ${isBad ? ' ‚ö†Ô∏è STAR√ù - SMAZAT!' : ' ‚úÖ'}
                    </p>`;
                });

                if (regs.length > 1) {
                    html += '<p class="error">‚ö†Ô∏è PROBL√âM: M√°≈° v√≠ce ne≈æ 1 SW!</p>';
                    // Show big warning banner
                    document.getElementById('sw-warning').style.display = 'block';
                } else {
                    document.getElementById('sw-warning').style.display = 'none';
                }

                status.innerHTML = html;
            } catch (err) {
                status.innerHTML = `<p class="error">Chyba: ${err.message}</p>`;
            }
        }

        async function cleanupServiceWorkers() {
            const status = document.getElementById('sw-status');
            status.innerHTML = '<p>ƒåist√≠m...</p>';

            try {
                const regs = await navigator.serviceWorker.getRegistrations();
                let cleaned = 0;

                for (const reg of regs) {
                    if (reg.active?.scriptURL.includes('/sw.js')) {
                        await reg.unregister();
                        cleaned++;
                    }
                }

                status.innerHTML = `<p class="success">‚úÖ Vyƒçi≈°tƒõno ${cleaned} star√Ωch SW</p>`;

                if (cleaned > 0) {
                    status.innerHTML += '<p class="warning">üîÑ Reloaduji str√°nku za 2 sekundy...</p>';
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                } else {
                    setTimeout(checkServiceWorkers, 1000);
                }
            } catch (err) {
                status.innerHTML = `<p class="error">Chyba: ${err.message}</p>`;
            }
        }

        async function checkTokens() {
            const status = document.getElementById('token-status');
            status.innerHTML = '<p>Kontroluji...</p>';

            try {
                const userId = localStorage.getItem('userId');
                if (!userId) {
                    status.innerHTML = '<p class="error">UserId not found!</p>';
                    return;
                }

                const response = await fetch(`/api/fcm/preferences/${userId}`);
                const data = await response.json();

                let html = `<p class="success">UserId: ${userId}</p>`;
                html += `<p>Poƒçet token≈Ø: ${data.tokens?.length || 0}</p>`;

                if (data.tokens && data.tokens.length > 0) {
                    data.tokens.forEach((token, i) => {
                        html += `<p>${i+1}. ${token.substring(0, 30)}...</p>`;
                    });

                    if (data.tokens.length > 1) {
                        html += '<p class="warning">‚ö†Ô∏è M√°≈° v√≠ce ne≈æ 1 token!</p>';
                    }
                }

                status.innerHTML = html;
            } catch (err) {
                status.innerHTML = `<p class="error">Chyba: ${err.message}</p>`;
            }
        }

        async function sendTestNotification() {
            const status = document.getElementById('test-status');
            status.innerHTML = '<p>Pos√≠l√°m...</p>';

            try {
                const userId = localStorage.getItem('userId');
                const response = await fetch('/api/debug/test-notification', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({userId})
                });

                const result = await response.json();

                status.innerHTML = `
                    <p class="success">‚úÖ Odesl√°no!</p>
                    <p>Success: ${result.result.successCount}</p>
                    <p>Failure: ${result.result.failureCount}</p>
                    <p class="warning">Kolik notifikac√≠ jsi dostal? Napi≈° to do konzole!</p>
                `;
            } catch (err) {
                status.innerHTML = `<p class="error">Chyba: ${err.message}</p>`;
            }
        }

        // Auto-run check on load
        window.addEventListener('load', () => {
            checkServiceWorkers();
            checkTokens();
        });
    </script>
</body>
</html>
